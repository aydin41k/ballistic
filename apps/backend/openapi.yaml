openapi: 3.0.3
info:
  title: Ballistic Backend API
  description: |
    API documentation for the Ballistic Backend application.
    
    This application provides item and project management with authentication features.
    
    ## Authentication
    The API uses both session-based authentication and token-based authentication via Laravel Sanctum.
    
    ### Session Authentication
    Web routes use session-based authentication with CSRF protection.
    
    ### Token Authentication
    API endpoints can use Bearer token authentication. To obtain a token:
    1. Register a new account via `POST /api/register` or
    2. Login with existing credentials via `POST /api/login`
    
    Include the token in subsequent requests using the `Authorization` header:
    ```
    Authorization: Bearer {your-token}
    ```
    
  version: 0.8.0
  contact:
    name: Ballistic Backend
  license:
    name: Proprietary

servers:
  - url: http://localhost
    description: Local development server
  - url: https://api.ballistic.app
    description: Production server

tags:
  - name: Authentication
    description: User authentication and registration endpoints (Session-based)
  - name: API Authentication
    description: API token-based authentication endpoints
  - name: Items
    description: Item management endpoints (API)
  - name: Users
    description: User lookup and management endpoints
  - name: Push Notifications
    description: Push notification subscription management
  - name: Profile
    description: User profile and settings management
  - name: Password
    description: Password management and reset
  - name: Email Verification
    description: Email verification endpoints
  - name: Stats
    description: User activity and productivity stats

paths:
  # API Authentication Routes
  /api/register:
    post:
      tags:
        - API Authentication
      summary: Register a new user (API)
      description: Create a new user account and receive an API token
      operationId: apiRegister
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - email
                - password
                - password_confirmation
              properties:
                name:
                  type: string
                  example: John Doe
                email:
                  type: string
                  format: email
                  example: john@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SecurePassword123
                password_confirmation:
                  type: string
                  format: password
                  minLength: 8
                  example: SecurePassword123
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User registered successfully
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
                    example: 1|abcdef1234567890abcdef1234567890
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /api/login:
    post:
      tags:
        - API Authentication
      summary: Login with API credentials
      description: Authenticate a user and receive an API token
      operationId: apiLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: john@example.com
                password:
                  type: string
                  format: password
                  example: SecurePassword123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Login successful
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
                    example: 2|abcdef1234567890abcdef1234567890
        '422':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /api/logout:
    post:
      tags:
        - API Authentication
      summary: Logout and revoke API token
      description: Revoke the user's current API token
      operationId: apiLogout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        '401':
          $ref: '#/components/responses/Unauthorised'

  # User Lookup
  /api/users/lookup:
    get:
      tags:
        - Users
      summary: Search for users
      description: |
        Search for users by exact email or phone number suffix (last 9 digits).
        Excludes the current authenticated user from results.
        Used for task assignment.
      operationId: lookupUsers
      security:
        - bearerAuth: []
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 3
            maxLength: 255
          description: Search query (email or phone number)
          example: "john@example.com"
      responses:
        '200':
          description: List of matching users
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserLookup'
        '401':
          $ref: '#/components/responses/Unauthorised'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  # Push Notifications
  /api/push/subscribe:
    post:
      tags:
        - Push Notifications
      summary: Subscribe to push notifications
      description: Register a push subscription for the authenticated user
      operationId: subscribePush
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - endpoint
                - keys
              properties:
                endpoint:
                  type: string
                  format: uri
                  maxLength: 500
                  example: "https://fcm.googleapis.com/fcm/send/..."
                keys:
                  type: object
                  required:
                    - p256dh
                    - auth
                  properties:
                    p256dh:
                      type: string
                      description: The P-256 public key
                    auth:
                      type: string
                      description: The authentication secret
      responses:
        '201':
          description: Push subscription created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Push subscription created successfully.
                  id:
                    type: string
                    format: uuid
        '401':
          $ref: '#/components/responses/Unauthorised'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /api/push/unsubscribe:
    delete:
      tags:
        - Push Notifications
      summary: Unsubscribe from push notifications
      description: Remove push subscription(s) for the authenticated user
      operationId: unsubscribePush
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                endpoint:
                  type: string
                  format: uri
                  maxLength: 500
                  description: Specific endpoint to unsubscribe. If not provided, all subscriptions are removed.
      responses:
        '200':
          description: Push subscription(s) removed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Push subscription(s) removed successfully.
                  deleted_count:
                    type: integer
                    example: 1
        '401':
          $ref: '#/components/responses/Unauthorised'

  # Authentication Routes
  /register:
    get:
      tags:
        - Authentication
      summary: Show registration form
      description: Display the registration page
      operationId: showRegister
      responses:
        '200':
          description: Registration form displayed
          content:
            text/html:
              schema:
                type: string
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: Create a new user account
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - email
                - password
                - password_confirmation
              properties:
                name:
                  type: string
                  example: John Doe
                email:
                  type: string
                  format: email
                  example: john@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SecurePassword123
                password_confirmation:
                  type: string
                  format: password
                  minLength: 8
                  example: SecurePassword123
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /login:
    get:
      tags:
        - Authentication
      summary: Show login form
      description: Display the login page
      operationId: showLogin
      responses:
        '200':
          description: Login form displayed
          content:
            text/html:
              schema:
                type: string
    post:
      tags:
        - Authentication
      summary: Authenticate user
      description: Log in an existing user
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: john@example.com
                password:
                  type: string
                  format: password
                  example: SecurePassword123
                remember:
                  type: boolean
                  example: true
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Login successful
        '422':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /logout:
    post:
      tags:
        - Authentication
      summary: Log out user
      description: End the authenticated user's session
      operationId: logout
      security:
        - sessionAuth: []
      responses:
        '204':
          description: Logout successful
        '401':
          $ref: '#/components/responses/Unauthorised'

  /forgot-password:
    get:
      tags:
        - Password
      summary: Show forgot password form
      description: Display the password reset request form
      operationId: showForgotPassword
      responses:
        '200':
          description: Forgot password form displayed
          content:
            text/html:
              schema:
                type: string
    post:
      tags:
        - Password
      summary: Send password reset link
      description: Send a password reset link to the user's email
      operationId: sendPasswordResetLink
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: john@example.com
      responses:
        '200':
          description: Password reset link sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset link sent to your email
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /reset-password/{token}:
    get:
      tags:
        - Password
      summary: Show password reset form
      description: Display the password reset form with token
      operationId: showResetPassword
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
          description: Password reset token
      responses:
        '200':
          description: Password reset form displayed
          content:
            text/html:
              schema:
                type: string

  /reset-password:
    post:
      tags:
        - Password
      summary: Reset password
      description: Reset the user's password using the reset token
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - email
                - password
                - password_confirmation
              properties:
                token:
                  type: string
                  example: abc123token
                email:
                  type: string
                  format: email
                  example: john@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: NewSecurePassword123
                password_confirmation:
                  type: string
                  format: password
                  minLength: 8
                  example: NewSecurePassword123
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset successfully
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /verify-email:
    get:
      tags:
        - Email Verification
      summary: Show email verification prompt
      description: Display the email verification notice
      operationId: showVerifyEmail
      security:
        - sessionAuth: []
      responses:
        '200':
          description: Email verification prompt displayed
          content:
            text/html:
              schema:
                type: string
        '401':
          $ref: '#/components/responses/Unauthorised'

  /verify-email/{id}/{hash}:
    get:
      tags:
        - Email Verification
      summary: Verify email address
      description: Verify the user's email address using verification link
      operationId: verifyEmail
      security:
        - sessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: User ID
        - name: hash
          in: path
          required: true
          schema:
            type: string
          description: Verification hash
      responses:
        '302':
          description: Email verified, redirected
        '401':
          $ref: '#/components/responses/Unauthorised'
        '403':
          description: Invalid verification link

  /email/verification-notification:
    post:
      tags:
        - Email Verification
      summary: Resend verification email
      description: Resend the email verification notification
      operationId: resendVerificationEmail
      security:
        - sessionAuth: []
      responses:
        '200':
          description: Verification email sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Verification email sent
        '401':
          $ref: '#/components/responses/Unauthorised'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /confirm-password:
    get:
      tags:
        - Password
      summary: Show password confirmation form
      description: Display the password confirmation form
      operationId: showConfirmPassword
      security:
        - sessionAuth: []
      responses:
        '200':
          description: Password confirmation form displayed
          content:
            text/html:
              schema:
                type: string
        '401':
          $ref: '#/components/responses/Unauthorised'
    post:
      tags:
        - Password
      summary: Confirm password
      description: Confirm the user's password for sensitive operations
      operationId: confirmPassword
      security:
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - password
              properties:
                password:
                  type: string
                  format: password
                  example: SecurePassword123
      responses:
        '200':
          description: Password confirmed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password confirmed
        '401':
          $ref: '#/components/responses/Unauthorised'
        '422':
          description: Invalid password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  # Settings/Profile Routes
  /settings/profile:
    get:
      tags:
        - Profile
      summary: Show profile edit form
      description: Display the profile edit page
      operationId: showEditProfile
      security:
        - sessionAuth: []
      responses:
        '200':
          description: Profile edit form displayed
          content:
            text/html:
              schema:
                type: string
        '401':
          $ref: '#/components/responses/Unauthorised'
    patch:
      tags:
        - Profile
      summary: Update profile
      description: Update the authenticated user's profile information
      operationId: updateProfile
      security:
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: John Doe
                email:
                  type: string
                  format: email
                  example: john@example.com
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorised'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
    delete:
      tags:
        - Profile
      summary: Delete account
      description: Delete the authenticated user's account
      operationId: deleteAccount
      security:
        - sessionAuth: []
      responses:
        '204':
          description: Account deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorised'

  /settings/password:
    get:
      tags:
        - Password
      summary: Show password edit form
      description: Display the password change form
      operationId: showEditPassword
      security:
        - sessionAuth: []
      responses:
        '200':
          description: Password edit form displayed
          content:
            text/html:
              schema:
                type: string
        '401':
          $ref: '#/components/responses/Unauthorised'
    put:
      tags:
        - Password
      summary: Update password
      description: Update the authenticated user's password
      operationId: updatePassword
      security:
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - current_password
                - password
                - password_confirmation
              properties:
                current_password:
                  type: string
                  format: password
                  example: CurrentPassword123
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: NewPassword123
                password_confirmation:
                  type: string
                  format: password
                  minLength: 8
                  example: NewPassword123
      responses:
        '200':
          description: Password updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password updated successfully
        '401':
          $ref: '#/components/responses/Unauthorised'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /settings/appearance:
    get:
      tags:
        - Profile
      summary: Show appearance settings
      description: Display the appearance settings page
      operationId: showAppearance
      security:
        - sessionAuth: []
      responses:
        '200':
          description: Appearance settings displayed
          content:
            text/html:
              schema:
                type: string
        '401':
          $ref: '#/components/responses/Unauthorised'

  # API Routes - Items
  /api/items:
    get:
      tags:
        - Items
      summary: List all items
      description: |
        Retrieve a list of items for the authenticated user.

        By default, returns items owned by the user that are NOT assigned to anyone else.
        Completed/cancelled items are excluded by default.

        Use `assigned_to_me=true` to get items assigned to you by other users.
        Use `delegated=true` to get items you own that are assigned to others.
        Use `scope=planned` to get future-scheduled items only.
        Use `include_completed=true` to include completed/cancelled items.

        Can be further filtered by project_id, status, scheduling scope, and date ranges.
      operationId: getItems
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - name: assigned_to_me
          in: query
          required: false
          schema:
            type: boolean
          description: Return items assigned to the current user by others
        - name: delegated
          in: query
          required: false
          schema:
            type: boolean
          description: Return items owned by current user that are assigned to others
        - name: project_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Filter items by project ID
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [todo, doing, done, wontdo]
          description: Filter items by status
        - name: scope
          in: query
          required: false
          schema:
            type: string
            enum: [active, planned, all]
            default: active
          description: |
            Controls which items are returned based on scheduling.
            active (default): Items with no scheduled_date or scheduled_date <= today.
            planned: Items with scheduled_date > today.
            all: All items regardless of scheduling.
        - name: tag_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Filter items by tag ID
        - name: scheduled_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Filter items for an exact scheduled date
        - name: scheduled_from
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Filter items with scheduled_date >= this date
        - name: scheduled_to
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Filter items with scheduled_date <= this date
        - name: due_from
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Filter items with due_date >= this date
        - name: due_to
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Filter items with due_date <= this date
        - name: overdue
          in: query
          required: false
          schema:
            type: boolean
          description: If true, only return items whose due_date has passed and are not done/wontdo
      responses:
        '200':
          description: List of items retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Item'
        '401':
          $ref: '#/components/responses/Unauthorised'

    post:
      tags:
        - Items
      summary: Create a new item
      description: Create a new item for the authenticated user
      operationId: createItem
      security:
        - bearerAuth: []
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - status
              properties:
                title:
                  type: string
                  maxLength: 65535
                  example: Complete project documentation
                description:
                  type: string
                  nullable: true
                  maxLength: 65535
                  example: Write comprehensive API documentation
                status:
                  type: string
                  enum: [todo, doing, done, wontdo]
                  example: todo
                project_id:
                  type: string
                  format: uuid
                  nullable: true
                  example: 123e4567-e89b-12d3-a456-426614174000
                assignee_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: User ID to assign this item to
                  example: 123e4567-e89b-12d3-a456-426614174003
                position:
                  type: integer
                  minimum: 0
                  example: 0
                scheduled_date:
                  type: string
                  format: date
                  nullable: true
                  description: When this item becomes active (YYYY-MM-DD)
                  example: "2026-02-01"
                due_date:
                  type: string
                  format: date
                  nullable: true
                  description: Deadline for this item (YYYY-MM-DD). Must not be before scheduled_date.
                  example: "2026-02-15"
                recurrence_rule:
                  type: string
                  nullable: true
                  description: RRULE pattern for recurring items
                  example: "FREQ=DAILY"
                recurrence_strategy:
                  type: string
                  nullable: true
                  enum: [expires, carry_over]
                  description: How missed recurring instances are handled
                  example: carry_over
                tag_ids:
                  type: array
                  nullable: true
                  items:
                    type: string
                    format: uuid
                  description: Array of tag UUIDs to assign
      responses:
        '201':
          description: Item created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
        '401':
          $ref: '#/components/responses/Unauthorised'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /api/items/{id}:
    get:
      tags:
        - Items
      summary: Get a specific item
      description: Retrieve details of a specific item
      operationId: getItem
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Item ID
      responses:
        '200':
          description: Item details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
        '401':
          $ref: '#/components/responses/Unauthorised'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Items
      summary: Update an item (full update)
      description: Update all fields of an existing item
      operationId: updateItemPut
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Item ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  maxLength: 65535
                  example: Complete project documentation
                description:
                  type: string
                  nullable: true
                  maxLength: 65535
                  example: Write comprehensive API documentation
                status:
                  type: string
                  enum: [todo, doing, done, wontdo]
                  example: doing
                project_id:
                  type: string
                  format: uuid
                  nullable: true
                  example: 123e4567-e89b-12d3-a456-426614174000
                assignee_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: User ID to assign this item to (only owner can change)
                  example: 123e4567-e89b-12d3-a456-426614174003
                position:
                  type: integer
                  minimum: 0
                  example: 1
                scheduled_date:
                  type: string
                  format: date
                  nullable: true
                  description: When this item becomes active (YYYY-MM-DD)
                  example: "2026-02-01"
                due_date:
                  type: string
                  format: date
                  nullable: true
                  description: Deadline for this item (YYYY-MM-DD). Must not be before scheduled_date.
                  example: "2026-02-15"
                recurrence_rule:
                  type: string
                  nullable: true
                  description: RRULE pattern for recurring items
                  example: "FREQ=DAILY"
                recurrence_strategy:
                  type: string
                  nullable: true
                  enum: [expires, carry_over]
                  description: How missed recurring instances are handled
                  example: carry_over
                tag_ids:
                  type: array
                  nullable: true
                  items:
                    type: string
                    format: uuid
                  description: Array of tag UUIDs to assign
      responses:
        '200':
          description: Item updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
        '401':
          $ref: '#/components/responses/Unauthorised'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

    patch:
      tags:
        - Items
      summary: Update an item (partial update)
      description: Update specific fields of an existing item
      operationId: updateItemPatch
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Item ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  maxLength: 65535
                  example: Complete project documentation
                description:
                  type: string
                  nullable: true
                  maxLength: 65535
                  example: Write comprehensive API documentation
                status:
                  type: string
                  enum: [todo, doing, done, wontdo]
                  example: doing
                project_id:
                  type: string
                  format: uuid
                  nullable: true
                  example: 123e4567-e89b-12d3-a456-426614174000
                assignee_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: User ID to assign this item to (only owner can change)
                  example: 123e4567-e89b-12d3-a456-426614174003
                position:
                  type: integer
                  minimum: 0
                  example: 1
                scheduled_date:
                  type: string
                  format: date
                  nullable: true
                  description: When this item becomes active (YYYY-MM-DD)
                  example: "2026-02-01"
                due_date:
                  type: string
                  format: date
                  nullable: true
                  description: Deadline for this item (YYYY-MM-DD). Must not be before scheduled_date.
                  example: "2026-02-15"
                recurrence_rule:
                  type: string
                  nullable: true
                  description: RRULE pattern for recurring items
                  example: "FREQ=DAILY"
                recurrence_strategy:
                  type: string
                  nullable: true
                  enum: [expires, carry_over]
                  description: How missed recurring instances are handled
                  example: carry_over
                tag_ids:
                  type: array
                  nullable: true
                  items:
                    type: string
                    format: uuid
                  description: Array of tag UUIDs to assign
      responses:
        '200':
          description: Item updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
        '401':
          $ref: '#/components/responses/Unauthorised'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

    delete:
      tags:
        - Items
      summary: Delete an item
      description: Soft delete an item (moves to trash)
      operationId: deleteItem
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Item ID
      responses:
        '204':
          description: Item deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorised'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/items/reorder:
    post:
      tags:
        - Items
      summary: Bulk reorder items
      description: |
        Update the position of multiple items in a single request.
        Only items owned by the authenticated user will be updated; unowned IDs are silently skipped.
        Non-submitted items are automatically renumbered to positions after the submitted range to prevent position conflicts.
      operationId: reorderItems
      security:
        - bearerAuth: []
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - items
              properties:
                items:
                  type: array
                  maxItems: 100
                  description: Array of item ID / position pairs. Maximum 100 items.
                  items:
                    type: object
                    required:
                      - id
                      - position
                    properties:
                      id:
                        type: string
                        format: uuid
                        description: Item UUID
                        example: 123e4567-e89b-12d3-a456-426614174000
                      position:
                        type: integer
                        minimum: 0
                        maximum: 9999
                        description: New zero-based position for this item
                        example: 0
            example:
              items:
                - id: 123e4567-e89b-12d3-a456-426614174000
                  position: 0
                - id: 123e4567-e89b-12d3-a456-426614174001
                  position: 1
                - id: 123e4567-e89b-12d3-a456-426614174002
                  position: 2
      responses:
        '200':
          description: Items reordered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Items reordered successfully
        '401':
          $ref: '#/components/responses/Unauthorised'
        '422':
          description: Validation error (e.g. array exceeds 100 items, position exceeds 9999)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /api/items/{id}/generate-recurrences:
    post:
      tags:
        - Items
      summary: Generate recurring instances
      description: |
        Generate item instances from a recurring template within the given date range.
        The item must have a `recurrence_rule` set (i.e. be a recurring template).
        Existing instances for a given date are returned as-is; new instances are created for dates without one.
        Tags from the template are copied to each new instance.
      operationId: generateRecurrences
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the recurring template item
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - start_date
                - end_date
              properties:
                start_date:
                  type: string
                  format: date
                  description: Start of the date range (YYYY-MM-DD)
                  example: "2026-02-01"
                end_date:
                  type: string
                  format: date
                  description: End of the date range (YYYY-MM-DD). Must be on or after start_date.
                  example: "2026-02-28"
      responses:
        '200':
          description: Generated recurring instances
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Item'
        '400':
          description: Item is not a recurring template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: This item is not a recurring template.
        '401':
          $ref: '#/components/responses/Unauthorised'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /api/stats:
    get:
      tags:
        - Stats
      summary: Get activity stats
      description: |
        Return productivity stats for the authenticated user including a daily
        completion heatmap and a breakdown of completed items by project.
        Both datasets honour the requested date range.
      operationId: getStats
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Start date (YYYY-MM-DD). Defaults to 364 days ago.
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date
          description: End date (YYYY-MM-DD). Must be on or after `from`. Defaults to today.
      responses:
        '200':
          description: Stats retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'
        '401':
          $ref: '#/components/responses/Unauthorised'
        '422':
          description: Validation error (e.g. `to` is before `from`)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: Token
      description: Laravel Sanctum API token authentication
    sessionAuth:
      type: apiKey
      in: cookie
      name: laravel_session
      description: Laravel session-based authentication

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        name:
          type: string
          example: John Doe
        email:
          type: string
          format: email
          example: john@example.com
        phone:
          type: string
          maxLength: 20
          nullable: true
          example: "+61412345678"
        email_verified_at:
          type: string
          format: date-time
          nullable: true
          example: 2025-10-08T12:00:00.000000Z
        created_at:
          type: string
          format: date-time
          example: 2025-10-08T10:00:00.000000Z
        updated_at:
          type: string
          format: date-time
          example: 2025-10-08T10:00:00.000000Z
      required:
        - id
        - name
        - email

    UserLookup:
      type: object
      description: Minimal user info for assignment lookup
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        name:
          type: string
          example: John Doe
        email_masked:
          type: string
          description: Partially masked email for privacy
          example: "j***@example.com"
      required:
        - id
        - name
        - email_masked

    Project:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        user_id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174001
        name:
          type: string
          example: Personal Tasks
        color:
          type: string
          nullable: true
          example: "#3B82F6"
        archived_at:
          type: string
          format: date-time
          nullable: true
          example: null
        created_at:
          type: string
          format: date-time
          example: 2025-10-08T10:00:00.000000Z
        updated_at:
          type: string
          format: date-time
          example: 2025-10-08T10:00:00.000000Z
        deleted_at:
          type: string
          format: date-time
          nullable: true
          example: null
      required:
        - id
        - user_id
        - name

    Item:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        user_id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174001
        assignee_id:
          type: string
          format: uuid
          nullable: true
          description: ID of the user this item is assigned to
          example: 123e4567-e89b-12d3-a456-426614174003
        project_id:
          type: string
          format: uuid
          nullable: true
          example: 123e4567-e89b-12d3-a456-426614174002
        title:
          type: string
          example: Complete project documentation
        description:
          type: string
          nullable: true
          example: Write comprehensive API documentation
        status:
          type: string
          enum: [todo, doing, done, wontdo]
          example: todo
        position:
          type: integer
          example: 0
        scheduled_date:
          type: string
          format: date
          nullable: true
          description: The date this item is scheduled to become active (YYYY-MM-DD)
          example: "2026-02-01"
        due_date:
          type: string
          format: date
          nullable: true
          description: The deadline for this item (YYYY-MM-DD)
          example: "2026-02-15"
        completed_at:
          type: string
          format: date-time
          nullable: true
          description: When the item was marked as done (ISO 8601)
          example: null
        recurrence_rule:
          type: string
          nullable: true
          description: RRULE string for recurring items
          example: null
        recurrence_strategy:
          type: string
          nullable: true
          enum: [expires, carry_over]
          description: |
            How missed recurring instances are handled.
            expires: Past instances are automatically marked wontdo.
            carry_over: Past instances stay overdue until manually completed.
          example: null
        recurrence_parent_id:
          type: string
          format: uuid
          nullable: true
          description: UUID of the parent recurring template
          example: null
        is_recurring_template:
          type: boolean
          description: Whether this item is a recurring template
          example: false
        is_recurring_instance:
          type: boolean
          description: Whether this item was generated from a recurring template
          example: false
        is_assigned:
          type: boolean
          description: Whether this item is assigned to someone
          example: false
        is_delegated:
          type: boolean
          description: Whether the current user delegated this item to someone else
          example: false
        created_at:
          type: string
          format: date-time
          example: 2025-10-08T10:00:00.000000Z
        updated_at:
          type: string
          format: date-time
          example: 2025-10-08T10:00:00.000000Z
        deleted_at:
          type: string
          format: date-time
          nullable: true
          example: null
        project:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/Project'
        assignee:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/UserLookup'
        owner:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/UserLookup'
      required:
        - id
        - user_id
        - title
        - status
        - position
        - is_assigned
        - is_delegated

    HeatmapEntry:
      type: object
      properties:
        date:
          type: string
          format: date
          description: The calendar date (YYYY-MM-DD)
          example: "2026-01-31"
        completed_count:
          type: integer
          minimum: 0
          description: Number of items completed on this date
          example: 3
      required:
        - date
        - completed_count

    CategoryDistribution:
      type: object
      properties:
        project_id:
          type: string
          format: uuid
          nullable: true
          description: Project UUID, or null for Inbox items
          example: "123e4567-e89b-12d3-a456-426614174000"
        project_name:
          type: string
          description: Project name, or "Inbox" when project_id is null
          example: Work
        project_color:
          type: string
          nullable: true
          description: Hex colour code for the project
          example: "#3B82F6"
        completed_count:
          type: integer
          minimum: 1
          description: Number of items completed in this project within the date range
          example: 7
      required:
        - project_id
        - project_name
        - completed_count

    StatsResponse:
      type: object
      properties:
        heatmap:
          type: array
          description: Daily completion counts within the requested date range, ordered by date ascending
          items:
            $ref: '#/components/schemas/HeatmapEntry'
        category_distribution:
          type: array
          description: Completed items grouped by project, ordered by count descending
          items:
            $ref: '#/components/schemas/CategoryDistribution'
      required:
        - heatmap
        - category_distribution

    ValidationError:
      type: object
      properties:
        message:
          type: string
          example: The given data was invalid.
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          example:
            email:
              - The email field is required.
            password:
              - The password must be at least 8 characters.

    Error:
      type: object
      properties:
        message:
          type: string
          example: An error occurred

  responses:
    Unauthorised:
      description: Unauthorised - Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Unauthenticated.

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: This action is unauthorised.

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Resource not found.

    TooManyRequests:
      description: Too many requests - Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Too many requests. Please try again later.

